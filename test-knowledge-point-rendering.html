<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识点LaTeX渲染测试</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f9fafb;
        }
        .knowledge-point-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 8px;
        }
        .definition {
            color: #374151;
            line-height: 1.8;
        }
        .definition h2 {
            color: #1f2937;
            font-size: 18px;
            margin: 20px 0 12px 0;
        }
        .definition h3 {
            color: #374151;
            font-size: 16px;
            margin: 16px 0 8px 0;
        }
        .definition ol, .definition ul {
            margin: 12px 0;
            padding-left: 24px;
        }
        .definition li {
            margin: 8px 0;
        }
        .definition strong {
            color: #1f2937;
            font-weight: 600;
        }
        .related-concepts {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        .concept-tag {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
            margin: 4px 8px 4px 0;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .test-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .test-info h3 {
            margin: 0 0 8px 0;
            color: #92400e;
        }
        .test-info p {
            margin: 0;
            color: #78350f;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h3>🧪 LaTeX公式渲染测试</h3>
        <p>此页面测试MarkdownRenderer组件处理知识点中LaTeX公式的能力。将从API获取配方法知识点并渲染其定义中的数学公式。</p>
    </div>

    <div class="knowledge-point-card">
        <div class="title">配方法</div>
        <div id="status" class="status">正在加载知识点数据...</div>
        <div id="definition" class="definition" style="display: none;"></div>
        <div id="related-concepts" class="related-concepts" style="display: none;">
            <h4>相关概念：</h4>
            <div id="concepts-list"></div>
        </div>
    </div>

    <div class="knowledge-point-card">
        <div class="title">渲染测试对比</div>
        <div class="definition">
            <h3>原始LaTeX代码：</h3>
            <pre style="background: #f3f4f6; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 14px;">配方法是将二次方程 $ax^2 + bx + c = 0$ 转化为 $(x + m)^2 = n$ 的形式的解法。

## 基本步骤

1. **移项**：将常数项移到等号右边
   $ax^2 + bx = -c$

2. **系数化1**：两边同时除以 $a$
   $x^2 + \frac{b}{a}x = -\frac{c}{a}$

3. **配方**：两边同时加上一次项系数一半的平方
   $x^2 + \frac{b}{a}x + \left(\frac{b}{2a}\right)^2 = -\frac{c}{a} + \left(\frac{b}{2a}\right)^2$

4. **化简**：左边写成完全平方式
   $$\left(x + \frac{b}{2a}\right)^2 = \frac{b^2 - 4ac}{4a^2}$$

## 关键公式

配方后的标准形式：
$$\left(x + \frac{b}{2a}\right)^2 = \frac{\Delta}{4a^2}$$

其中判别式 $\Delta = b^2 - 4ac$</pre>
            
            <h3>渲染效果：</h3>
            <div id="manual-render" class="definition"></div>
        </div>
    </div>

    <script>
        // Unicode数学符号转LaTeX的映射（与MarkdownRenderer保持一致）
        function preprocessLatex(text) {
            return text
                // 积分符号
                .replace(/∫/g, '\\int')
                // 上标数字
                .replace(/¹/g, '^1')
                .replace(/²/g, '^2')
                .replace(/³/g, '^3')
                .replace(/⁴/g, '^4')
                .replace(/⁵/g, '^5')
                .replace(/⁶/g, '^6')
                .replace(/⁷/g, '^7')
                .replace(/⁸/g, '^8')
                .replace(/⁹/g, '^9')
                .replace(/⁰/g, '^0')
                // 下标数字
                .replace(/₁/g, '_1')
                .replace(/₂/g, '_2')
                .replace(/₃/g, '_3')
                .replace(/₄/g, '_4')
                .replace(/₅/g, '_5')
                .replace(/₆/g, '_6')
                .replace(/₇/g, '_7')
                .replace(/₈/g, '_8')
                .replace(/₉/g, '_9')
                .replace(/₀/g, '_0')
                // 分数符号
                .replace(/½/g, '\\frac{1}{2}')
                .replace(/⅓/g, '\\frac{1}{3}')
                .replace(/¼/g, '\\frac{1}{4}')
                .replace(/¾/g, '\\frac{3}{4}')
                // 求和符号
                .replace(/∑/g, '\\sum')
                // 希腊字母
                .replace(/α/g, '\\alpha')
                .replace(/β/g, '\\beta')
                .replace(/γ/g, '\\gamma')
                .replace(/δ/g, '\\delta')
                .replace(/ε/g, '\\epsilon')
                .replace(/θ/g, '\\theta')
                .replace(/λ/g, '\\lambda')
                .replace(/μ/g, '\\mu')
                .replace(/π/g, '\\pi')
                .replace(/σ/g, '\\sigma')
                .replace(/φ/g, '\\phi')
                .replace(/ω/g, '\\omega')
                // 其他数学符号
                .replace(/±/g, '\\pm')
                .replace(/∞/g, '\\infty')
                .replace(/√/g, '\\sqrt')
                .replace(/≤/g, '\\leq')
                .replace(/≥/g, '\\geq')
                .replace(/≠/g, '\\neq')
                .replace(/≈/g, '\\approx')
                .replace(/∆/g, '\\Delta');
        }

        // 模拟MarkdownRenderer的预处理逻辑
        function preprocessContent(text) {
            const mathPlaceholders = {};
            let placeholderIndex = 0;
            
            // 处理块级公式 $$...$$
            text = text.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
                const placeholder = `__BLOCK_MATH_${placeholderIndex++}__`;
                mathPlaceholders[placeholder] = preprocessLatex(formula.trim());
                return placeholder;
            });
            
            // 处理行内公式 $...$
            text = text.replace(/\$([^$]+)\$/g, (match, formula) => {
                const placeholder = `__INLINE_MATH_${placeholderIndex++}__`;
                mathPlaceholders[placeholder] = preprocessLatex(formula.trim());
                return placeholder;
            });
            
            return { text, mathPlaceholders };
        }

        // 渲染Markdown内容
        function renderMarkdown(content) {
            const { text, mathPlaceholders } = preprocessContent(content);
            
            // 简单的Markdown渲染（标题、列表、粗体）
            let html = text
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(\d+\.)\s+(.+)$/gm, '<li>$2</li>')
                .replace(/\n/g, '<br>');
            
            // 包装列表项
            html = html.replace(/((<li>.*?<\/li>)+)/g, '<ol>$1</ol>');
            
            // 替换数学公式占位符
            Object.keys(mathPlaceholders).forEach(placeholder => {
                const formula = mathPlaceholders[placeholder];
                if (placeholder.includes('BLOCK_MATH')) {
                    html = html.replace(placeholder, `$$${formula}$$`);
                } else {
                    html = html.replace(placeholder, `$${formula}$`);
                }
            });
            
            return html;
        }

        // 获取知识点数据
        async function fetchKnowledgePoint() {
            const statusEl = document.getElementById('status');
            const definitionEl = document.getElementById('definition');
            const conceptsEl = document.getElementById('related-concepts');
            const conceptsListEl = document.getElementById('concepts-list');
            
            try {
                statusEl.textContent = '正在从API获取数据...';
                statusEl.className = 'status';
                
                const response = await fetch('http://localhost:5001/api/knowledge-points/配方法?subject=数学');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'API返回失败状态');
                }
                
                const knowledgeData = data.data;
                
                // 显示成功状态
                statusEl.textContent = `✅ 成功获取知识点数据 (来源: ${knowledgeData.source})`;
                statusEl.className = 'status success';
                
                // 渲染定义
                const renderedDefinition = renderMarkdown(knowledgeData.definition);
                definitionEl.innerHTML = renderedDefinition;
                definitionEl.style.display = 'block';
                
                // 渲染相关概念
                if (knowledgeData.relatedConcepts && knowledgeData.relatedConcepts.length > 0) {
                    conceptsListEl.innerHTML = knowledgeData.relatedConcepts
                        .map(concept => `<span class="concept-tag">${concept}</span>`)
                        .join('');
                    conceptsEl.style.display = 'block';
                }
                
                // 渲染手动测试内容
                const manualContent = `配方法是将二次方程 $ax^2 + bx + c = 0$ 转化为 $(x + m)^2 = n$ 的形式的解法。

## 基本步骤

1. **移项**：将常数项移到等号右边
   $ax^2 + bx = -c$

2. **系数化1**：两边同时除以 $a$
   $x^2 + \\frac{b}{a}x = -\\frac{c}{a}$

3. **配方**：两边同时加上一次项系数一半的平方
   $x^2 + \\frac{b}{a}x + \\left(\\frac{b}{2a}\\right)^2 = -\\frac{c}{a} + \\left(\\frac{b}{2a}\\right)^2$

4. **化简**：左边写成完全平方式
   $$\\left(x + \\frac{b}{2a}\\right)^2 = \\frac{b^2 - 4ac}{4a^2}$$

## 关键公式

配方后的标准形式：
$$\\left(x + \\frac{b}{2a}\\right)^2 = \\frac{\\Delta}{4a^2}$$

其中判别式 $\\Delta = b^2 - 4ac$`;
                
                document.getElementById('manual-render').innerHTML = renderMarkdown(manualContent);
                
                // 渲染所有数学公式
                setTimeout(() => {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        errorCallback: function(msg, err) {
                            console.error('KaTeX渲染错误:', msg, err);
                        }
                    });
                }, 100);
                
            } catch (error) {
                console.error('获取知识点失败:', error);
                statusEl.textContent = `❌ 获取知识点失败: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // 页面加载完成后获取数据
        document.addEventListener('DOMContentLoaded', fetchKnowledgePoint);
    </script>
</body>
</html>