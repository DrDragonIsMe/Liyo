<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaTeXæ¸²æŸ“é—®é¢˜è¯Šæ–­</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #007acc;
            padding-bottom: 5px;
        }
        .formula-test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
        }
        .formula-original {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }
        .formula-cleaned {
            background: #d1ecf1;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
            border-left: 4px solid #17a2b8;
        }
        .formula-rendered {
            background: #d4edda;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            min-height: 40px;
        }
        .formula-error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #dc3545;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ” LaTeXå…¬å¼æ¸²æŸ“é—®é¢˜è¯Šæ–­</h1>
    <p>æ¨¡æ‹ŸMarkdownRendererç»„ä»¶çš„å¤„ç†è¿‡ç¨‹ï¼Œæ‰¾å‡ºå“ªäº›å…¬å¼æ¸²æŸ“å¤±è´¥å¯¼è‡´æ˜¾ç¤ºåŸå§‹è¯­æ³•ã€‚</p>
    
    <div class="test-section">
        <div class="test-title">é…æ–¹æ³•çŸ¥è¯†ç‚¹ä¸­çš„æ•°å­¦å…¬å¼æµ‹è¯•</div>
        <div id="formula-tests"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">é—®é¢˜æ€»ç»“</div>
        <div id="summary"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸMarkdownRendererçš„cleanMathContentå‡½æ•°
        function cleanMathContent(mathContent) {
            return mathContent
                // ç§»é™¤ä¸­æ–‡æ ‡ç‚¹ç¬¦å·
                .replace(/[ï¼Œã€‚ï¼›ï¼šï¼Ÿï¼ï¼ˆï¼‰ã€ã€‘ã€Œã€ã€ã€]/g, '')
                // ç§»é™¤ä¸­æ–‡å­—ç¬¦
                .replace(/[\u4e00-\u9fff]/g, '')
                // æ¸…ç†å¤šä½™ç©ºæ ¼
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // æ¨¡æ‹ŸMarkdownRendererçš„preprocessLatexå‡½æ•°
        function preprocessLatex(text) {
            return text
                // æ¸…ç†ä¸­æ–‡æ ‡ç‚¹ç¬¦å·
                .replace(/ï¼Œ/g, ',')
                .replace(/ã€‚/g, '.')
                .replace(/ï¼›/g, ';')
                .replace(/ï¼š/g, ':')
                .replace(/ï¼Ÿ/g, '?')
                .replace(/ï¼/g, '!')
                .replace(/ï¼ˆ/g, '(')
                .replace(/ï¼‰/g, ')')
                .replace(/ã€/g, '[')
                .replace(/ã€‘/g, ']')
                .replace(/ã€Œ/g, '"')
                .replace(/ã€/g, '"')
                .replace(/ã€/g, '"')
                .replace(/ã€/g, '"')
                // å¤„ç†åŒåæ–œæ è½¬ä¹‰é—®é¢˜
                .replace(/\\\\frac/g, '\\frac')
                .replace(/\\\\sqrt/g, '\\sqrt')
                .replace(/\\\\pm/g, '\\pm')
                .replace(/\\\\times/g, '\\times')
                .replace(/\\\\div/g, '\\div')
                .replace(/\\\\cdot/g, '\\cdot')
                .replace(/\\\\sum/g, '\\sum')
                .replace(/\\\\int/g, '\\int')
                .replace(/\\\\lim/g, '\\lim')
                .replace(/\\\\sin/g, '\\sin')
                .replace(/\\\\cos/g, '\\cos')
                .replace(/\\\\tan/g, '\\tan')
                .replace(/\\\\log/g, '\\log')
                .replace(/\\\\ln/g, '\\ln')
                .replace(/\\\\alpha/g, '\\alpha')
                .replace(/\\\\beta/g, '\\beta')
                .replace(/\\\\gamma/g, '\\gamma')
                .replace(/\\\\delta/g, '\\delta')
                .replace(/\\\\pi/g, '\\pi')
                .replace(/\\\\theta/g, '\\theta')
                .replace(/\\\\infty/g, '\\infty')
                .replace(/\\\\leq/g, '\\leq')
                .replace(/\\\\geq/g, '\\geq')
                .replace(/\\\\neq/g, '\\neq')
                .replace(/\\\\approx/g, '\\approx')
                .replace(/\\\\equiv/g, '\\equiv')
                .replace(/\\\\begin/g, '\\begin')
                .replace(/\\\\end/g, '\\end')
                .replace(/\\\\left/g, '\\left')
                .replace(/\\\\right/g, '\\right')
                // å¤„ç†å¸¸è§çš„Unicodeæ•°å­¦ç¬¦å·
                .replace(/Ã—/g, '\\times')
                .replace(/Ã·/g, '\\div')
                .replace(/Â±/g, '\\pm')
                .replace(/â‰¤/g, '\\leq')
                .replace(/â‰¥/g, '\\geq')
                .replace(/â‰ /g, '\\neq')
                .replace(/â‰ˆ/g, '\\approx')
                .replace(/âˆ/g, '\\infty')
                .replace(/Ï€/g, '\\pi')
                .replace(/Î±/g, '\\alpha')
                .replace(/Î²/g, '\\beta')
                .replace(/Î³/g, '\\gamma')
                .replace(/Î´/g, '\\delta')
                .replace(/Î¸/g, '\\theta')
                // å¤„ç†ä¸Šä¸‹æ ‡çš„Unicodeå­—ç¬¦
                .replace(/Â²/g, '^2')
                .replace(/Â³/g, '^3')
                .replace(/Â¹/g, '^1')
                .replace(/â‚/g, '_1')
                .replace(/â‚‚/g, '_2')
                .replace(/â‚ƒ/g, '_3');
        }
        
        function testFormula(originalFormula, type) {
            const testDiv = document.createElement('div');
            testDiv.className = 'formula-test';
            
            // æ˜¾ç¤ºåŸå§‹å…¬å¼
            const originalDiv = document.createElement('div');
            originalDiv.className = 'formula-original';
            originalDiv.innerHTML = `<strong>åŸå§‹:</strong> ${type === 'block' ? '$$' : '$'}${originalFormula}${type === 'block' ? '$$' : '$'}`;
            testDiv.appendChild(originalDiv);
            
            // æ¸…ç†åçš„å…¬å¼
            const cleanedFormula = cleanMathContent(originalFormula);
            const cleanedDiv = document.createElement('div');
            cleanedDiv.className = 'formula-cleaned';
            cleanedDiv.innerHTML = `<strong>æ¸…ç†å:</strong> ${cleanedFormula}`;
            testDiv.appendChild(cleanedDiv);
            
            // æ¸²æŸ“ç»“æœ
            const renderedDiv = document.createElement('div');
            renderedDiv.className = 'formula-rendered';
            
            try {
                if (type === 'block') {
                    katex.render(cleanedFormula, renderedDiv, {
                        displayMode: true,
                        throwOnError: true
                    });
                } else {
                    katex.render(cleanedFormula, renderedDiv, {
                        displayMode: false,
                        throwOnError: true
                    });
                }
                
                const statusDiv = document.createElement('div');
                statusDiv.innerHTML = '<span class="success">âœ… æ¸²æŸ“æˆåŠŸ</span>';
                testDiv.appendChild(statusDiv);
                
                return { success: true, formula: originalFormula, cleaned: cleanedFormula };
                
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'formula-error';
                errorDiv.innerHTML = `<strong>âŒ æ¸²æŸ“å¤±è´¥:</strong> ${error.message}`;
                testDiv.appendChild(errorDiv);
                
                // æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ï¼ˆæ¨¡æ‹ŸMarkdownRendererçš„fallbackè¡Œä¸ºï¼‰
                const fallbackDiv = document.createElement('div');
                fallbackDiv.innerHTML = `<strong>Fallbackæ˜¾ç¤º:</strong> <span style="background: #f8d7da; padding: 4px; border-radius: 4px;">${type === 'block' ? '$$' : '$'}${originalFormula}${type === 'block' ? '$$' : '$'}</span>`;
                testDiv.appendChild(fallbackDiv);
                
                return { success: false, formula: originalFormula, cleaned: cleanedFormula, error: error.message };
            } finally {
                testDiv.appendChild(renderedDiv);
                document.getElementById('formula-tests').appendChild(testDiv);
            }
        }
        
        function runDiagnosis() {
            const content = `é…æ–¹æ³•æ˜¯è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹çš„ä¸€ç§é‡è¦æ–¹æ³•ã€‚å¯¹äºä¸€èˆ¬å½¢å¼çš„ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹ $ax^2 + bx + c = 0$ (å…¶ä¸­ $a \\neq 0$)ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…æ–¹å°†å…¶è½¬åŒ–ä¸º $(x + m)^2 = n$ çš„å½¢å¼ã€‚\n\nå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. **ç§»é¡¹**ï¼šå°†å¸¸æ•°é¡¹ç§»åˆ°ç­‰å·å³è¾¹\n   $ax^2 + bx = -c$\n\n2. **ç³»æ•°åŒ–1**ï¼šå°†äºŒæ¬¡é¡¹ç³»æ•°åŒ–ä¸º1\n   $x^2 + \\frac{b}{a}x = -\\frac{c}{a}$\n\n3. **é…æ–¹**ï¼šåœ¨ç­‰å¼ä¸¤è¾¹åŒæ—¶åŠ ä¸Šä¸€æ¬¡é¡¹ç³»æ•°ä¸€åŠçš„å¹³æ–¹\n   $x^2 + \\frac{b}{a}x + \\left(\\frac{b}{2a}\\right)^2 = -\\frac{c}{a} + \\left(\\frac{b}{2a}\\right)^2$\n\n4. **åŒ–ç®€**ï¼šå·¦è¾¹é…æˆå®Œå…¨å¹³æ–¹å¼\n   $$\\left(x + \\frac{b}{2a}\\right)^2 = \\frac{b^2 - 4ac}{4a^2}$$\n\n5. **å¼€æ–¹æ±‚è§£**ï¼š\n   - å½“åˆ¤åˆ«å¼ $\\Delta = b^2 - 4ac > 0$ æ—¶ï¼Œæ–¹ç¨‹æœ‰ä¸¤ä¸ªä¸ç›¸ç­‰çš„å®æ•°æ ¹\n   - å½“åˆ¤åˆ«å¼ $\\Delta = b^2 - 4ac = 0$ æ—¶ï¼Œæ–¹ç¨‹æœ‰ä¸¤ä¸ªç›¸ç­‰çš„å®æ•°æ ¹\n   - å½“åˆ¤åˆ«å¼ $\\Delta = b^2 - 4ac < 0$ æ—¶ï¼Œæ–¹ç¨‹æ— å®æ•°æ ¹\n\n**ç¤ºä¾‹**ï¼šè§£æ–¹ç¨‹ $x^2 + 4x + 1 = 0$\n\nè§£ï¼š$x^2 + 4x = -1$\n\né…æ–¹ï¼š$x^2 + 4x + 4 = -1 + 4$\n\nå³ï¼š$(x + 2)^2 = 3$\n\nå¼€æ–¹ï¼š$x + 2 = \\pm\\sqrt{3}$\n\næ‰€ä»¥ï¼š$x = -2 \\pm \\sqrt{3}$`;
            
            const processedText = preprocessLatex(content);
            
            // æå–æ‰€æœ‰æ•°å­¦å…¬å¼
            const blockMatches = [];
            const inlineMatches = [];
            
            // åŒ¹é…å—çº§å…¬å¼ $$...$$
            const blockMathRegex = /\$\$([^$]+)\$\$/g;
            let blockMatch;
            while ((blockMatch = blockMathRegex.exec(processedText)) !== null) {
                blockMatches.push(blockMatch[1].trim());
            }
            
            // åŒ¹é…è¡Œå†…å…¬å¼ $...$
            const inlineMathRegex = /\$([^$]+)\$/g;
            let inlineMatch;
            while ((inlineMatch = inlineMathRegex.exec(processedText)) !== null) {
                // æ£€æŸ¥æ˜¯å¦ä¸å—çº§å…¬å¼é‡å 
                const isBlockFormula = blockMatches.some(block => block.includes(inlineMatch[1].trim()));
                if (!isBlockFormula) {
                    inlineMatches.push(inlineMatch[1].trim());
                }
            }
            
            console.log('å—çº§å…¬å¼:', blockMatches);
            console.log('è¡Œå†…å…¬å¼:', inlineMatches);
            
            const results = {
                total: blockMatches.length + inlineMatches.length,
                success: 0,
                failed: 0,
                failedFormulas: []
            };
            
            // æµ‹è¯•å—çº§å…¬å¼
            blockMatches.forEach(formula => {
                const result = testFormula(formula, 'block');
                if (result.success) {
                    results.success++;
                } else {
                    results.failed++;
                    results.failedFormulas.push({ type: 'block', ...result });
                }
            });
            
            // æµ‹è¯•è¡Œå†…å…¬å¼
            inlineMatches.forEach(formula => {
                const result = testFormula(formula, 'inline');
                if (result.success) {
                    results.success++;
                } else {
                    results.failed++;
                    results.failedFormulas.push({ type: 'inline', ...result });
                }
            });
            
            // æ˜¾ç¤ºæ€»ç»“
            const summaryDiv = document.getElementById('summary');
            let summaryHTML = `
                <h3>è¯Šæ–­ç»“æœ</h3>
                <ul>
                    <li><strong>æ€»å…¬å¼æ•°:</strong> ${results.total}</li>
                    <li><strong>æˆåŠŸæ¸²æŸ“:</strong> <span class="success">${results.success}</span></li>
                    <li><strong>æ¸²æŸ“å¤±è´¥:</strong> <span class="error">${results.failed}</span></li>
                </ul>
            `;
            
            if (results.failed > 0) {
                summaryHTML += `
                    <h4>å¤±è´¥çš„å…¬å¼:</h4>
                    <ul>
                `;
                results.failedFormulas.forEach((failed, index) => {
                    summaryHTML += `
                        <li>
                            <strong>${failed.type === 'block' ? 'å—çº§' : 'è¡Œå†…'}å…¬å¼ ${index + 1}:</strong><br>
                            <code>${failed.formula}</code><br>
                            <span class="error">é”™è¯¯: ${failed.error}</span>
                        </li>
                    `;
                });
                summaryHTML += `</ul>`;
                
                summaryHTML += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #ffc107;">
                        <h4>ğŸ” é—®é¢˜åˆ†æ</h4>
                        <p>è¿™äº›å¤±è´¥çš„å…¬å¼ä¼šåœ¨MarkdownRendererç»„ä»¶ä¸­è§¦å‘catchå—ï¼Œå¯¼è‡´æ˜¾ç¤ºåŸå§‹çš„LaTeXè¯­æ³•è€Œä¸æ˜¯æ¸²æŸ“åçš„æ•°å­¦å…¬å¼ã€‚</p>
                        <p><strong>è¿™å°±æ˜¯ç”¨æˆ·åé¦ˆçš„"æœ‰äº›æ˜¯å…¬å¼ï¼Œæœ‰äº›è¿˜æ˜¯åŸæ¥çš„è¯­æ³•"é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼</strong></p>
                    </div>
                `;
            } else {
                summaryHTML += `
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #28a745;">
                        <h4>âœ… æ‰€æœ‰å…¬å¼æ¸²æŸ“æ­£å¸¸</h4>
                        <p>å¦‚æœåœ¨å®é™…åº”ç”¨ä¸­ä»æœ‰é—®é¢˜ï¼Œå¯èƒ½æ˜¯å…¶ä»–çŸ¥è¯†ç‚¹çš„å…¬å¼å­˜åœ¨é—®é¢˜ã€‚</p>
                    </div>
                `;
            }
            
            summaryDiv.innerHTML = summaryHTML;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹è¯Šæ–­
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runDiagnosis, 100);
        });
    </script>
</body>
</html>