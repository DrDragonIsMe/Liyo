<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>渲染器对比调试</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react-markdown@8.0.7/react-markdown.min.js"></script>
    <script src="https://unpkg.com/remark-gfm@3.0.1/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .renderer-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .renderer-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007acc;
        }
        .test-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #007acc;
        }
        .original-text {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #ffeaa7;
        }
        .debug-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
            color: #1565c0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>MathRenderer vs MarkdownRenderer 对比调试</h1>
    <p>测试相同的LaTeX内容在两个渲染器中的表现差异</p>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 测试内容
        const testContents = [
            {
                name: "基本LaTeX公式",
                content: "配方法是将二次方程 $ax^2 + bx + c = 0$ 转化为 $(x + m)^2 = n$ 的形式。"
            },
            {
                name: "块级公式",
                content: "求解公式：$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$"
            },
            {
                name: "混合内容",
                content: "对于方程 $ax^2 + bx + c = 0$，当判别式 $\\Delta = b^2 - 4ac > 0$ 时，方程有两个不同的实根：$$x_{1,2} = \\frac{-b \\pm \\sqrt{\\Delta}}{2a}$$"
            },
            {
                name: "Markdown + LaTeX",
                content: "## 配方法\n\n配方法的基本步骤：\n\n1. **移项**：$ax^2 + bx = -c$\n2. **配方**：$(x + \\frac{b}{2a})^2 = \\frac{b^2 - 4ac}{4a^2}$"
            }
        ];
        
        // 简化的MathRenderer组件
        const SimpleMathRenderer = ({ content }) => {
            const [renderedContent, setRenderedContent] = useState('');
            const [debugInfo, setDebugInfo] = useState('');
            
            useEffect(() => {
                try {
                    // 预处理LaTeX
                    const preprocessLatex = (text) => {
                        return text
                            .replace(/\\\\frac/g, '\\frac')
                            .replace(/\\\\sqrt/g, '\\sqrt')
                            .replace(/\\\\pm/g, '\\pm')
                            .replace(/\\\\Delta/g, '\\Delta');
                    };
                    
                    const processedText = preprocessLatex(content);
                    setDebugInfo(`预处理后: ${processedText}`);
                    
                    // 简单的数学公式解析
                    const parts = [];
                    let lastIndex = 0;
                    
                    // 匹配块级公式
                    const blockRegex = /\$\$([^$]+)\$\$/g;
                    let match;
                    const matches = [];
                    
                    while ((match = blockRegex.exec(processedText)) !== null) {
                        matches.push({
                            start: match.index,
                            end: match.index + match[0].length,
                            content: match[1].trim(),
                            type: 'block'
                        });
                    }
                    
                    // 匹配行内公式
                    const inlineRegex = /\$([^$]+)\$/g;
                    while ((match = inlineRegex.exec(processedText)) !== null) {
                        const isOverlapping = matches.some(m => 
                            match.index >= m.start && match.index < m.end
                        );
                        if (!isOverlapping) {
                            matches.push({
                                start: match.index,
                                end: match.index + match[0].length,
                                content: match[1].trim(),
                                type: 'inline'
                            });
                        }
                    }
                    
                    matches.sort((a, b) => a.start - b.start);
                    
                    let result = processedText;
                    // 简单替换为KaTeX渲染标记
                    matches.forEach(m => {
                        if (m.type === 'block') {
                            result = result.replace(`$$${m.content}$$`, `[BLOCK_MATH]${m.content}[/BLOCK_MATH]`);
                        } else {
                            result = result.replace(`$${m.content}$`, `[INLINE_MATH]${m.content}[/INLINE_MATH]`);
                        }
                    });
                    
                    setRenderedContent(result);
                } catch (error) {
                    setDebugInfo(`错误: ${error.message}`);
                }
            }, [content]);
            
            return (
                <div>
                    <div className="debug-info">{debugInfo}</div>
                    <div className="test-content">
                        {renderedContent.split('\n').map((line, i) => (
                            <div key={i}>{line || <br />}</div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // 简化的MarkdownRenderer组件
        const SimpleMarkdownRenderer = ({ content }) => {
            const [renderedContent, setRenderedContent] = useState('');
            const [debugInfo, setDebugInfo] = useState('');
            
            useEffect(() => {
                try {
                    // 预处理LaTeX（与MathRenderer相同）
                    const preprocessLatex = (text) => {
                        return text
                            .replace(/\\\\frac/g, '\\frac')
                            .replace(/\\\\sqrt/g, '\\sqrt')
                            .replace(/\\\\pm/g, '\\pm')
                            .replace(/\\\\Delta/g, '\\Delta');
                    };
                    
                    const processedText = preprocessLatex(content);
                    setDebugInfo(`预处理后: ${processedText}`);
                    
                    // 模拟ReactMarkdown的处理
                    let result = processedText;
                    
                    // Markdown处理
                    result = result
                        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/^(\d+\.)\s+(.+)$/gm, '<li>$2</li>')
                        .replace(/\n/g, '<br>');
                    
                    // 包装列表
                    result = result.replace(/((<li>.*?<\/li>)+)/g, '<ol>$1</ol>');
                    
                    setRenderedContent(result);
                } catch (error) {
                    setDebugInfo(`错误: ${error.message}`);
                }
            }, [content]);
            
            return (
                <div>
                    <div className="debug-info">{debugInfo}</div>
                    <div className="test-content" dangerouslySetInnerHTML={{ __html: renderedContent }} />
                </div>
            );
        };
        
        // 主应用组件
        const App = () => {
            const [selectedTest, setSelectedTest] = useState(0);
            
            return (
                <div>
                    <div style={{ marginBottom: '20px' }}>
                        <label>选择测试内容: </label>
                        <select 
                            value={selectedTest} 
                            onChange={(e) => setSelectedTest(parseInt(e.target.value))}
                            style={{ padding: '5px', marginLeft: '10px' }}
                        >
                            {testContents.map((test, index) => (
                                <option key={index} value={index}>{test.name}</option>
                            ))}
                        </select>
                    </div>
                    
                    <div className="original-text">
                        <strong>原始内容:</strong><br/>
                        {testContents[selectedTest].content}
                    </div>
                    
                    <div className="comparison-container">
                        <div className="renderer-section">
                            <div className="renderer-title">MathRenderer</div>
                            <SimpleMathRenderer content={testContents[selectedTest].content} />
                        </div>
                        
                        <div className="renderer-section">
                            <div className="renderer-title">MarkdownRenderer</div>
                            <SimpleMarkdownRenderer content={testContents[selectedTest].content} />
                        </div>
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
        
        // 渲染KaTeX公式
        setTimeout(() => {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }, 500);
    </script>
</body>
</html>